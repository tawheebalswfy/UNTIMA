name: DTAF Complete Lab Environment

on:
  workflow_dispatch:
    inputs:
      run_time:
        description: 'Run duration (minutes)'
        required: true
        default: '120'
      run_experiments:
        description: 'Run experiments automatically'
        required: true
        default: 'true'
        type: boolean

jobs:
  setup-dtaf:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.run_time }}
    
    steps:
    - name: Checkout DTAF Project
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Ubuntu Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libxmu-dev \
          tcl8.6-dev \
          tk8.6-dev \
          python3 \
          python3-pip \
          python3-venv \
          python3-dev \
          gcc \
          g++ \
          make \
          wget \
          curl \
          git \
          dos2unix
        
    - name: Install NS2
      run: |
        cd /tmp
        wget -q https://sourceforge.net/projects/nsnam/files/allinone/ns-allinone-2.35/ns-allinone-2.35.tar.gz
        tar -xzvf ns-allinone-2.35.tar.gz
        cd ns-allinone-2.35
        ./install 2>&1 | tail -50
        export PATH="/tmp/ns-allinone-2.35/ns-2.35:$PATH"
        echo "PATH=$PATH" >> $GITHUB_ENV
        
    - name: Setup Python Environment
      run: |
        python3 -m venv dtaf_venv
        source dtaf_venv/bin/activate
        pip install --upgrade pip
        pip install numpy pandas matplotlib scipy seaborn jupyter
        echo "PYTHON_VENV=$(pwd)/dtaf_venv" >> $GITHUB_ENV
        
    - name: Compile DTAF Module
      run: |
        cd ${{ github.workspace }}
        chmod +x compile_dtaf.sh
        ./compile_dtaf.sh
        
    - name: Run DTAF Experiments
      if: ${{ github.event.inputs.run_experiments == 'true' }}
      run: |
        cd ${{ github.workspace }}
        chmod +x run_all_experiments.sh
        timeout 1800 ./run_all_experiments.sh || echo "Experiments completed or timed out"
        
    - name: Generate Analysis Reports
      run: |
        cd ${{ github.workspace }}
        source dtaf_venv/bin/activate
        python3 scripts/advanced_analyze.py
        
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: DTAF-Results-${{ github.run_id }}
        path: |
          results/
          logs/
          *.html
          *.png
          
    - name: Create Summary Report
      run: |
        echo "# DTAF Project Run Report" > summary.md
        echo "## Run ID: ${{ github.run_id }}" >> summary.md
        echo "## Repository: https://github.com/tawheebalswfy/DTAF_Project" >> summary.md
        echo "## Date: $(date)" >> summary.md
        echo "## Duration: ${{ github.event.inputs.run_time }} minutes" >> summary.md
        echo "" >> summary.md
        echo "### Generated Files:" >> summary.md
        find results/ -name "*.tr" | head -10 | while read file; do
          echo "- $file ($(wc -l < "$file") lines)" >> summary.md
        done
        
    - name: Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: Summary-Report
        path: summary.md
